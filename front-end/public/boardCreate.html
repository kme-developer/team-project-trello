<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Trello</title>
  <!-- google font -->
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@500&family=Roboto:wght@500&display=swap"
    rel="stylesheet" />
  <!-- bootstrap css -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.1/dist/css/bootstrap.min.css" rel="stylesheet"
    integrity="sha384-4bw+/aepP/YC94hEpVNVgiZdgIC5+VKNBQNGCHeKRQN+PtmoHDEXuppvnDJzQIu9" crossorigin="anonymous" />
  <!-- css -->
  <link rel="stylesheet" href="./css/reset.css" />
  <link rel="stylesheet" href="./css/boardCreate.css" />
</head>

<body>
  <header class="bg-dark text-light">
    <div class="container py-3">
      <div class="row justify-content-between align-items-center">
        <div class="col-auto">
          <h1>Trello</h1>
        </div>
        <div class="col-auto">
          <button class="btn btn-primary me-2" data-bs-toggle="modal" data-bs-target="#createModal">
            Create
          </button>
          <button class="btn btn-primary me-2" id="logoutButton" onclick="logout()">
            Log Out
          </button>
        </div>
      </div>
    </div>
  </header>

  <!-- Edit Modal -->
  <div class="modal fade" id="editModal" tabindex="-1" aria-labelledby="editModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="signupModalLabel">
            Edit User Infomation
          </h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <form>
            <div class="mb-3">
              <label for="password" class="form-label"></label>
              <input type="password" class="form-control" id="password" placeholder="password" />
            </div>
            <div class="mb-3">
              <label for="password" class="form-label"></label>
              <input type="password" class="form-control" id="newPassword" placeholder="new password" />
            </div>
            <div class="text-center mb-3">
              <p id="precondition">
                8자리 이상, 영대문자, 소문자, 숫자를 반드시 포함해야 합니다.
              </p>
            </div>
            <div class="mb-3">
              <label for="name" class="form-label"></label>
              <input type="name" class="form-control" id="name" placeholder="name" />
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
            Cancel
          </button>
          <button type="button" class="btn btn-primary" onclick="updateUserInfo()">
            Edit
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Image Modal -->
  <div class="modal fade" id="imageModal" tabindex="-1" aria-labelledby="imageModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="signupModalLabel">
            Edit User Infomation
          </h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <form>
            <div class="text-center mb-3">
              <label for="backgroundImage">profile image: </label>
              <input type="file" class="form-control-file" id="backgroundImage" />
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
            Cancel
          </button>
          <button type="button" class="btn btn-primary" onclick="updateUserImage()">
            Submit
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Sign Out Modal -->
  <div class="modal fade" id="signOutModal" tabindex="-1" aria-labelledby="signOutModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="signupModalLabel">
            Edit User Infomation
          </h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <form>
            <div class="mb-3">
              <label for="password" class="form-label"></label>
              <input type="password" class="form-control" id="passwordForSignOut" placeholder="password" />
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
            Cancel
          </button>
          <button type="button" class="btn btn-primary" onclick="deleteUser()">
            Sign Out
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Create Modal -->
  <div class="modal fade" id="createModal" tabindex="-1" aria-labelledby="createModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="createModalLabel">Create New Board</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <form>
            <!-- <div class="mb-3">
                <label for="backgroundImage">background:</label>
                <input
                  type="file"
                  class="form-control-file"
                  id="backgroundImage"
                />
              </div> -->
            <div class="mb-3">
              <label for="boardTitle"></label>
              <input type="text" class="form-control" id="boardTitle" placeholder="title" />
            </div>
            <div class="mb-3">
              <label for="boardDescription"></label>
              <textarea class="form-control" id="boardDescription" rows="5" placeholder="description"></textarea>
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
            Cancel
          </button>
          <button type="button" class="btn btn-primary" onclick="createBoard()">
            Create
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Update Modal -->
  <div class="modal fade" id="updateModal" tabindex="-1" aria-labelledby="updateModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="updateModalLabel">Update Board</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <form>
            <div class="mb-3">
              <label for="boardTitleUpdate"></label>
              <input type="text" class="form-control" id="boardTitleUpdate" placeholder="title" />
            </div>
            <div class="mb-3">
              <label for="boardDescriptionUpdate"></label>
              <textarea class="form-control" id="boardDescriptionUpdate" rows="5" placeholder="description"></textarea>
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
            Cancel
          </button>
          <button type="button" class="btn btn-primary" id="updateBoardButton">
            Update
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Invite Modal -->
  <div class="modal fade" id="inviteModal" tabindex="-1" aria-labelledby="inviteModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="inviteModalLabel">Invite User</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <form>
            <div class="mb-3">
              <label for="inviteEmail"></label>
              <input type="email" class="form-control" id="inviteEmail" placeholder="user email" />
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
            Cancel
          </button>
          <button type="button" class="btn btn-primary" id="inviteButton">
            Invite
          </button>
        </div>
      </div>
    </div>
  </div>

  <div class="container mt-4">
    <div class="row">
      <!-- 사용자 영역 -->
      <div class="col-md-6">
        <div class="card mb-3" id="user-card">
          <div class="d-flex flex-column align-items-center" id="user-profile-image">
            <img src="https://upload.wikimedia.org/wikipedia/commons/thumb/a/a8/NestJS.svg/1200px-NestJS.svg.png"
              alt="Profile Picture" class="rounded-circle" width="200" height="200" />
            <div class="text-center">
              <h3 id="user-name">name</h3>
              <p id="user-email">e-mail</p>
            </div>
            <div class="mt-3">
              <button class="btn btn-primary me-2" data-bs-toggle="modal" data-bs-target="#editModal">
                Edit
              </button>
              <button class="btn btn-primary me-2" data-bs-toggle="modal" data-bs-target="#imageModal">
                Image
              </button>
              <button class="btn btn-primary me-2" data-bs-toggle="modal" data-bs-target="#signOutModal">
                Sign Out
              </button>
            </div>
          </div>
        </div>
      </div>
      <!-- 사용자 영역 아래에 추가된 부분 -->
      <div class="col-md-6">
        <div class="row mt-4">
          <div class="col-md-12">
            <h3 class="text-md-center">My Boards</h3>
            <ul class="list-group" id="myBoardsList"></ul>
          </div>
        </div>
        <div class="row mt-4">
          <div class="col-md-12">
            <h3 class="text-md-center">Invited Boards</h3>
            <ul class="list-group" id="invitedBoardsList"></ul>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- bootstrap js -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.1/dist/js/bootstrap.bundle.min.js"
    integrity="sha384-HwwvtgBNo3bZJJLYd8oVXjrBZt8cqVSpeBNS5n7C8IVInixGAoxmnlMuBnhbgrkm"
    crossorigin="anonymous"></script>

  <script>
    let editModal = new bootstrap.Modal(document.getElementById('editModal'));
    let createModal = new bootstrap.Modal(
      document.getElementById('createModal'),
    );

    window.onload = function () {
      if (!getCookie()) {
        window.location.href =
          'http://127.0.0.1:5500/front-end/public/index.html';
      }
      getUserImage();
      getUserInfo();
      fetchBoards();
      fetchInvitedBoards(); // Fetch and display invited boards
    };

    function logout() {
      try {
        deleteCookie();
        alert('사용자 인증 해제 성공');
        window.location.href =
          'http://127.0.0.1:5500/front-end/public/index.html';
      } catch {
        alert('사용자 인증 해제 실패');
      }
    }

    function getUserInfo() {
      fetch('http://localhost:8080/users', {
        method: 'GET',
        headers: {
          'Content-Type': 'application/json',
          Authorization: getCookie(),
        },
        credentials: 'include',
      })
        .then((response) => response.json())
        .then((data) => {
          const userNameElement = document.getElementById('user-name');
          userNameElement.textContent = data.data.name;
          const userEmailElement = document.getElementById('user-email');
          userEmailElement.textContent = data.data.email;
        })
        .catch((error) => {
          console.error('this is error =>', error);
        });
    }

    function getUserImage() {
      fetch('http://localhost:8080/users/image', {
        method: 'GET',
        headers: {
          Authorization: getCookie(),
        },
        credentials: 'include',
      })
        .then((response) => response.json())
        .then((data) => {
          console.log(data.data);
          if (
            data.data === 'https://inflearn-nest-cat.s3.amazonaws.com/null'
          ) {
          } else {
            const userImageElement =
              document.getElementById('user-profile-image');
            const userImage = data.data;
            const profileImageElement = userImageElement.querySelector('img');
            profileImageElement.src = userImage;
          }
        })
        .catch((error) => {
          console.error('this is error =>', error);
        });
    }

    function updateUserInfo() {
      const userData = {
        password: document.getElementById('password').value,
        newPassword: document.getElementById('newPassword').value,
        name: document.getElementById('name').value,
      };

      fetch('http://localhost:8080/users', {
        method: 'PATCH',
        headers: {
          'Content-Type': 'application/json',
          Authorization: getCookie(),
        },
        credentials: 'include',
        body: JSON.stringify(userData),
      })
        .then((response) => response.json())
        .then((data) => {
          if (data.data.message === '회원정보 수정 성공') {
            closeModal();
            alert('회원정보 수정 성공');
            window.location.href =
              'http://127.0.0.1:5500/front-end/public/boardCreate.html';
          } else {
            alert('회원정보 수정 실패');
          }
        })
        .catch((error) => {
          console.error('this is error =>', error);
        });
    }

    function updateUserImage() {
      const backgroundImageInput = document.getElementById('backgroundImage');
      const selectedFile = backgroundImageInput.files[0];
      const formData = new FormData();
      formData.append('image', selectedFile);

      fetch('http://localhost:8080/users/image', {
        method: 'POST',
        headers: {
          Authorization: getCookie(),
        },
        credentials: 'include',
        body: formData,
      })
        .then((response) => response.json())
        .then((data) => {
          if (data.success === true) {
            closeModal();
            alert('사진 수정 성공');
            window.location.href =
              'http://127.0.0.1:5500/front-end/public/boardCreate.html';
          } else {
            alert('사진 수정 실패');
          }
        })
        .catch((error) => {
          console.error('this is error =>', error);
        });
    }

    function deleteUser() {
      fetch('http://localhost:8080/users', {
        method: 'DELETE',
        headers: {
          'Content-Type': 'application/json',
          Authorization: getCookie(),
        },
        credentials: 'include',
      })
        .then((response) => response.json())
        .then((data) => {
          if (data.success === true) {
            closeModal();
            alert('회원탈퇴 성공');
            window.location.href =
              'http://127.0.0.1:5500/front-end/public/index.html';
          } else {
            alert('회원탈퇴 실패');
          }
        })
        .catch((error) => {
          console.error('this is error =>', error);
        });
    }

    function getCookie() {
      const cookie = decodeURIComponent(document.cookie);
      console.log(cookie);
      const [name, value] = cookie.split('=');
      return value;
    }

    function deleteCookie() {
      document.cookie =
        'Authorization=; expires=Sat, 01 Jan 2000 00:00:00 UTC; path=/;';
    }

    function closeModal() {
      editModal.hide();
      createModal.hide();
    }

    function createBoard() {
      const boardTitle = document.getElementById('boardTitle').value;
      const boardDescription =
        document.getElementById('boardDescription').value;

      const authToken = getCookie();

      const data = {
        title: boardTitle,
        description: boardDescription,
        // ... other properties you might want to include ...
      };

      fetch('http://localhost:8080/boards', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          Authorization: authToken,
        },
        credentials: 'include',
        body: JSON.stringify(data),
      })
        .then((response) => response.json())
        .then((data) => {
          // Handle the response as needed
          alert('보드가 생성되었습니다.');
          location.reload();
          console.log('Board created successfully:', data);
        })
        .catch((error) => {
          alert('보드 생성에 실패하였습니다.');
          location.reload();
          console.error('Error creating board:', error);
        });
    }

    function fetchBoards() {
      fetch('http://localhost:8080/boards/createdBoards', {
        method: 'GET',
        headers: {
          'Content-Type': 'application/json',
          Authorization: getCookie(),
        },
        credentials: 'include',
      })
        .then((response) => response.json())
        .then((data) => {
          const myBoardsList = document.getElementById('myBoardsList');

          // 기존 목록 비우기
          myBoardsList.innerHTML = '';

          // 보드 목록을 동적으로 생성
          data.forEach((board) => {
            const listItem = document.createElement('li');
            listItem.className =
              'list-group-item d-flex justify-content-between align-items-center';
            listItem.id = board.id;

            // 보드 이름 텍스트 추가
            const boardText = document.createElement('span');
            boardText.textContent = board.title;
            listItem.appendChild(boardText);

            // 버튼 추가
            const buttons = document.createElement('div');
            buttons.className = 'btn-group';

            // Invite 버튼
            const inviteButton = document.createElement('button');
            inviteButton.className = 'btn btn-success me-1';
            inviteButton.textContent = 'Invite';
            inviteButton.onclick = function (event) {
              event.stopPropagation(); // 클릭 이벤트 전파 차단
              showInviteModal(board.id); // Invite 버튼 클릭 시 showInviteModal 함수 호출
            };
            buttons.appendChild(inviteButton);

            // Update 버튼
            const updateButton = document.createElement('button');
            updateButton.className = 'btn btn-warning me-1';
            updateButton.textContent = 'Update';
            updateButton.addEventListener('click', function (event) {
              event.stopPropagation(); // 클릭 이벤트 전파 차단
              showUpdateModal(board.id); // Update 버튼 클릭 시 showUpdateModal 함수 호출
            });
            buttons.appendChild(updateButton);

            // Delete 버튼
            const deleteButton = document.createElement('button');
            deleteButton.className = 'btn btn-danger';
            deleteButton.textContent = 'Delete';
            deleteButton.addEventListener('click', function (event) {
              event.stopPropagation(); // 클릭 이벤트 전파 차단
              showDeleteConfirmation(board.id); // Delete 버튼 클릭 시 showDeleteConfirmation 함수 호출
            });
            buttons.appendChild(deleteButton);

            listItem.appendChild(buttons);

            // 클릭 이벤트 핸들러 추가
            listItem.addEventListener('click', function () {
              // 보드 상세 페이지로 이동
              window.location.href = `boardDetail.html?id=${board.id}`;
            });

            myBoardsList.appendChild(listItem);
          });
        })
        .catch((error) => {
          console.error('Error fetching boards:', error);
        });
    }

    // Fetch and display invited boards
    function fetchInvitedBoards() {
      const authToken = getCookie();
      const invitedBoardsList = document.getElementById('invitedBoardsList');

      fetch('http://localhost:8080/boards/invitedBoards', {
        method: 'GET',
        headers: {
          'Content-Type': 'application/json',
          Authorization: authToken,
        },
        credentials: 'include',
      })
        .then((response) => response.json())
        .then((data) => {
          // Clear existing list
          invitedBoardsList.innerHTML = '';

          // Create and append list items dynamically
          data.forEach((board) => {
            const listItem = document.createElement('li');
            listItem.className =
              'list-group-item d-flex justify-content-between align-items-center';
            listItem.id = board.id;

            // 클릭 이벤트 핸들러 추가
            listItem.addEventListener('click', function () {
              // 보드 상세 페이지로 이동
              window.location.href = `boardDetail.html?id=${board.board.id}`;
            });

            // 보드 이름 텍스트 추가
            const boardText = document.createElement('span');
            boardText.textContent = board.board.title;
            listItem.appendChild(boardText);

            // 삭제 버튼 추가
            const deleteButton = document.createElement('button');
            deleteButton.className = 'btn btn-danger';
            deleteButton.textContent = 'Delete';
            deleteButton.addEventListener('click', function (event) {
              event.stopPropagation();
              const confirmResult = confirm('보드에서 나가시겠습니까?');
              if (confirmResult) {
                leaveBoard(board.board.id); // API 요청을 보내는 함수 호출
              }
            });
            listItem.appendChild(deleteButton);

            invitedBoardsList.appendChild(listItem);
          });
        })
        .catch((error) => {
          console.error('Error fetching invited boards:', error);
        });
    }

    // Update 버튼 클릭 시
    function showUpdateModal(boardId) {
      const updateModal = new bootstrap.Modal(
        document.getElementById('updateModal'),
      );
      const boardTitleInput = document.getElementById('boardTitleUpdate');
      const boardDescriptionInput = document.getElementById(
        'boardDescriptionUpdate',
      );

      // 모달 내용 초기화
      boardTitleInput.value = '';
      boardDescriptionInput.value = '';

      // Update 버튼 클릭 시 이벤트 처리
      const updateBoardButton = document.getElementById('updateBoardButton');
      updateBoardButton.addEventListener('click', function () {
        const updatedTitle = boardTitleInput.value;
        const updatedDescription = boardDescriptionInput.value;

        if (updatedTitle && updatedDescription) {
          updateBoard(boardId, updatedTitle, updatedDescription);
        } else {
          alert('Title and Description cannot be empty.');
        }
      });
      // 모달 보여주기
      updateModal.show();
    }

    function updateBoard(boardId, title, description) {
      const authToken = getCookie();
      const data = {
        title: title,
        description: description,
      };

      fetch(`http://localhost:8080/boards/${boardId}`, {
        method: 'PUT',
        headers: {
          'Content-Type': 'application/json',
          Authorization: authToken,
        },
        credentials: 'include',
        body: JSON.stringify(data),
      })
        .then((response) => response.json())
        .then((data) => {
          // Handle the response as needed
          alert('수정되었습니다.');
          location.reload();
          console.log('Board updated successfully:', data);
        })
        .catch((error) => {
          alert('수정에 실패하였습니다.');
          location.reload();
          console.error('Error updating board:', error);
        });
    }

    // Delete 버튼 클릭 시
    function showDeleteConfirmation(boardId) {
      if (confirm('보드를 삭제하시겠습니까?')) {
        const authToken = getCookie();

        fetch(`http://localhost:8080/boards/${boardId}`, {
          method: 'DELETE',
          headers: {
            'Content-Type': 'application/json',
            Authorization: authToken,
          },
          credentials: 'include',
        })
          .then((response) => {
            alert('삭제되었습니다.');
            location.reload();
          })
          .catch((error) => {
            alert('보드 삭제에 실패하였습니다.');
            location.reload();
            console.error('Error deleting board:', error);
          });
      }
    }

    // 모달 보여주는 함수
    function showInviteModal(boardId) {
      const inviteModal = new bootstrap.Modal(
        document.getElementById('inviteModal'),
      );
      inviteModal.show();

      // Invite 버튼의 이벤트 핸들러 설정
      setupInviteButton(boardId);
    }

    // inviteButton의 onclick 핸들러를 추가한 함수
    function setupInviteButton(boardId) {
      const inviteButton = document.getElementById('inviteButton');
      inviteButton.onclick = function () {
        const emailInput = document.getElementById('inviteEmail');
        const email = emailInput.value;
        inviteUserToBoard(boardId, email);
      };
    }

    // invite 모달 내에서 사용자를 보드에 초대하는 함수
    function inviteUserToBoard(boardId, email) {
      const authToken = getCookie();
      const data = {
        email: email,
      };

      fetch(`http://localhost:8080/boards/invite/${boardId}`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          Authorization: authToken,
        },
        credentials: 'include',
        body: JSON.stringify(data),
      })
        .then((response) => response.json())
        .then((data) => {
          alert('보드에 초대되었습니다.');
          location.reload();
        })
        .catch((error) => {
          alert('보드 초대에 실패하였습니다.');
          location.reload();
          console.error('Error inviting user to board:', error);
        });
    }

    // 보드에서 나가기 요청을 보내는 함수
    function leaveBoard(boardId) {
      const authToken = getCookie();

      fetch(`http://localhost:8080/boards/invitedBoards/${boardId}`, {
        method: 'DELETE',
        headers: {
          'Content-Type': 'application/json',
          Authorization: authToken,
        },
        credentials: 'include',
      })
        .then((response) => response.json())
        .then((data) => {
          alert('보드에서 나갔습니다.');
          location.reload();
        })
        .catch((error) => {
          alert('보드에서 나가기 실패');
          location.reload();
          console.error('Error leaving board:', error);
        });
    }
  </script>
</body>

</html>