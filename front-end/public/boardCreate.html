<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Trello</title>
  <!-- google font -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@500&family=Roboto:wght@500&display=swap"
    rel="stylesheet">
  <!-- bootstrap css -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.1/dist/css/bootstrap.min.css" rel="stylesheet"
    integrity="sha384-4bw+/aepP/YC94hEpVNVgiZdgIC5+VKNBQNGCHeKRQN+PtmoHDEXuppvnDJzQIu9" crossorigin="anonymous" />
  <!-- css -->
  <link rel="stylesheet" href="./css/reset.css">
  <link rel="stylesheet" href="./css/boardCreate.css">
</head>

<body>
  <header class="bg-dark text-light">
    <div class="container py-3">
      <div class="row justify-content-between align-items-center">
        <div class="col-auto">
          <h1>Trello</h1>
        </div>
        <div class="col-auto">
          <button class="btn btn-primary me-2" data-bs-toggle="modal" data-bs-target="#createModal">Create</button>
          <button class="btn btn-primary me-2" id="logoutButton" onclick="logout()">Log Out</button>
        </div>
      </div>
    </div>
  </header>

  <!-- Edit Modal -->
  <div class="modal fade" id="editModal" tabindex="-1" aria-labelledby="editModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="signupModalLabel">Edit User Infomation</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <form>
            <div class="mb-3">
              <label for="password" class="form-label"></label>
              <input type="password" class="form-control" id="password" placeholder="password" />
            </div>
            <div class="mb-3">
              <label for="password" class="form-label"></label>
              <input type="password" class="form-control" id="newPassword" placeholder="new password" />
            </div>
            <div class="text-center mb-3">
              <p id="precondition">8자리 이상, 영대문자, 소문자, 숫자를 반드시 포함해야 합니다.</p>
            </div>
            <div class="mb-3">
              <label for="name" class="form-label"></label>
              <input type="name" class="form-control" id="name" placeholder="name" />
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
            Cancel
          </button>
          <button type="button" class="btn btn-primary" onclick="updateUserInfo()">
            Edit
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Image Modal -->
  <div class="modal fade" id="imageModal" tabindex="-1" aria-labelledby="imageModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="signupModalLabel">Edit User Infomation</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <form>
            <div class="text-center mb-3">
              <label for="backgroundImage">profile image: </label>
              <input type="file" class="form-control-file" id="backgroundImage" />
            </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
            Cancel
          </button>
          <button type="button" class="btn btn-primary" onclick="updateUserImage()">
            Submit
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Sign Out Modal -->
  <div class="modal fade" id="signOutModal" tabindex="-1" aria-labelledby="signOutModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="signupModalLabel">Edit User Infomation</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <form>
            <div class="mb-3">
              <label for="password" class="form-label"></label>
              <input type="password" class="form-control" id="passwordForSignOut" placeholder="password" />
            </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
            Cancel
          </button>
          <button type="button" class="btn btn-primary" onclick="deleteUser()">
            Sign Out
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Create Modal -->
  <div class="modal fade" id="createModal" tabindex="-1" aria-labelledby="createModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="createModalLabel">Create New Board</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <form>
            <div class="mb-3">
              <label for="boardTitle"></label>
              <input type="text" class="form-control" id="boardTitle" placeholder="title" />
            </div>
            <div class="mb-3">
              <label for="boardDescription"></label>
              <textarea class="form-control" id="boardDescription" rows="5" placeholder="description"></textarea>
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
            Cancel
          </button>
          <button type="button" class="btn btn-primary" onclick="">
            Create
          </button>
        </div>
      </div>
    </div>
  </div>

  <div class="container mt-4">
    <div class="row">
      <!-- 사용자 영역 -->
      <div class="col-md-6">
        <div class="card mb-3" id="user-card">
          <div class="d-flex flex-column align-items-center" id="user-profile-image">
            <img src="https://upload.wikimedia.org/wikipedia/commons/thumb/a/a8/NestJS.svg/1200px-NestJS.svg.png"
              alt="Profile Picture" class="rounded-circle" width="200" height="200">
            <div class="text-center">
              <h3 id="user-name">name</h3>
              <p id="user-email">e-mail</p>
            </div>
            <div class="mt-3">
              <button class="btn btn-primary me-2" data-bs-toggle="modal" data-bs-target="#editModal">Edit</button>
              <button class="btn btn-primary me-2" data-bs-toggle="modal" data-bs-target="#imageModal">Image</button>
              <button class="btn btn-primary me-2" data-bs-toggle="modal" data-bs-target="#signOutModal">Sign
                Out</button>
            </div>
          </div>
        </div>
      </div>

      <div class="col-md-6 text-md-right">
        <h3>My Boards</h3>
        <ul class="list-group">
          <li class="list-group-item">김재용</li>
          <li class="list-group-item">김태진</li>
        </ul>
      </div>
    </div>
    <div class="row mt-4">
      <div class="col-md-6"></div>
      <div class="col-md-6">
        <h3>Invited Boards</h3>
        <ul class="list-group">
          <li class="list-group-item">정영훈</li>
          <li class="list-group-item">최성구</li>
        </ul>
      </div>
    </div>
  </div>

  <!-- bootstrap js -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.1/dist/js/bootstrap.bundle.min.js"
    integrity="sha384-HwwvtgBNo3bZJJLYd8oVXjrBZt8cqVSpeBNS5n7C8IVInixGAoxmnlMuBnhbgrkm"
    crossorigin="anonymous"></script>

  <script>
    let editModal = new bootstrap.Modal(
      document.getElementById("editModal")
    );
    let createModal = new bootstrap.Modal(
      document.getElementById("createModal")
    );

    window.onload = function () {
      if (!getCookie()) {
        window.location.href = "http://127.0.0.1:5500/front-end/public/index.html";
      }
      getUserImage();
      getUserInfo();
    };

    function logout() {
      try {
        deleteCookie();
        alert("사용자 인증 해제 성공");
        window.location.href = "http://127.0.0.1:5500/front-end/public/index.html";
      } catch {
        alert("사용자 인증 해제 실패");
      };
    }

    function getUserInfo() {
      fetch("http://localhost:8080/users", {
        method: "GET",
        headers: {
          "Content-Type": "application/json",
          "Authorization": getCookie(),
        },
        credentials: "include",
      })
        .then((response) => response.json())
        .then((data) => {
          const userNameElement = document.getElementById("user-name");
          userNameElement.textContent = data.data.name;
          const userEmailElement = document.getElementById("user-email");
          userEmailElement.textContent = data.data.email;
        })
        .catch((error) => {
          console.error("this is error =>", error);
        });
    }

    function updateUserInfo() {
      const userData = {
        password: document.getElementById("password").value,
        newPassword: document.getElementById("newPassword").value,
        name: document.getElementById("name").value,
      };

      fetch("http://localhost:8080/users", {
        method: "PATCH",
        headers: {
          "Content-Type": "application/json",
          "Authorization": getCookie(),
        },
        credentials: "include",
        body: JSON.stringify(userData),
      })
        .then((response) => response.json())
        .then((data) => {
          if (data.data.message === "회원정보 수정 성공") {
            closeModal();
            alert("회원정보 수정 성공")
            window.location.href = "http://127.0.0.1:5500/front-end/public/boardCreate.html";
          } else {
            alert("회원정보 수정 실패");
          }
        })
        .catch((error) => {
          console.error("this is error =>", error);
        });
    }

    function getUserImage() {
      fetch("http://localhost:8080/users/image", {
        method: "GET",
        headers: {
          "Authorization": getCookie(),
        },
        credentials: "include",
      })
        .then((response) => response.json())
        .then((data) => {
          if (data.data === 'https://inflearn-nest-cat.s3.amazonaws.com/') {
          } else {
            const userImageElement = document.getElementById("user-profile-image");
            const userImage = data.data;
            const profileImageElement = userImageElement.querySelector("img");
            profileImageElement.src = userImage;
          }
        })
        .catch((error) => {
          console.error("this is error =>", error);
        });
    }

    function updateUserImage() {
      const backgroundImageInput = document.getElementById('backgroundImage');
      const selectedFile = backgroundImageInput.files[0];
      const formData = new FormData();
      formData.append('image', selectedFile);

      fetch("http://localhost:8080/users/image", {
        method: "POST",
        headers: {
          "Authorization": getCookie(),
        },
        credentials: "include",
        body: formData,
      })
        .then((response) => response.json())
        .then((data) => {
          if (data.success === true) {
            closeModal();
            alert("사진 수정 성공")
            window.location.href = "http://127.0.0.1:5500/front-end/public/boardCreate.html";
          } else {
            alert("사진 수정 실패");
          }
        })
        .catch((error) => {
          console.error("this is error =>", error);
        });
    }

    function deleteUser() {
      fetch("http://localhost:8080/users", {
        method: "DELETE",
        headers: {
          "Content-Type": "application/json",
          "Authorization": getCookie(),
        },
        credentials: "include",
      })
        .then((response) => response.json())
        .then((data) => {
          if (data.success === true) {
            closeModal();
            alert("회원탈퇴 성공")
            window.location.href = "http://127.0.0.1:5500/front-end/public/index.html";
          } else {
            alert("회원탈퇴 실패");
          }
        })
        .catch((error) => {
          console.error("this is error =>", error);
        });
    }

    function getCookie() {
      const cookie = decodeURIComponent(document.cookie);
      const [name, value] = cookie.split("=");
      return value;
    }

    function deleteCookie() {
      document.cookie = "Authorization=; expires=Sat, 01 Jan 2000 00:00:00 UTC; path=/;";
    }

    function closeModal() {
      editModal.hide();
      createModal.hide();
    }
  </script>
</body>

</html>